<!doctype HTML>
<html>
  <head>
    <title>GRAPHS!</title>
    <meta charset="utf-8" />
    <script src="https://code.jquery.com/jquery-1.11.3.js"></script>
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <style>
      body {
        margin: 0px auto;
        width: 1000px;
        font-family: Arial;
      }

      h2,p {
        text-align: center;
      }

      .graph {
        width: 100%;
        height: 600px;
      }
    </style>
    <script>
      var roomNames = {};

      function generateChartOptions(graph) {
        return {
          chart: {events: {load: function() {graph.graph = this;}}},
          legend: {enabled: true},
          rangeSelector: {
            buttons: [{
              count: 1,
              type: 'minute',
              text: '1M'
            }, {
              count: 5,
              type: 'minute',
              text: '5M'
            }, {
              count: 60,
              type: 'minute',
              text: '1H'
            }, {
              count: 120,
              type: 'minute',
              text: '2H'
            }, {
              count: 360,
              type: 'minute',
              text: '6H'
            }, {
              type: 'all',
              text: 'All'
            }],
            inputEnabled: false,
            selected: 0
          },
          title: {
            text: graph.name
          }
        }
      }

      function createUpdateChart(stat) {
        return function(graph, data) {
          var time = new Date().getTime();

          for (var roomID in data) {
            if (graph.rooms.indexOf(roomID) === -1) {
              graph.graph.addSeries({
                name: roomNames[roomID] ? roomID + ' (' + roomNames[roomID] + ')' : roomID
              });
              graph.rooms.push(roomID);
            }

            for (var s in this.rooms) if (this.rooms[s] === roomID) {
              graph.graph.series[s].addPoint([time, data[roomID][stat]], true);

              break;
            }
          }
        }
      }

      // TERRIBLE CODE, I KNOW. WAS RUSHING IT
      var graphs = {
        level: {
          name: 'Level',
          init: function(graphContainer) {
            this.rooms = [];

            graphContainer.highcharts('StockChart', generateChartOptions(this));
          },
          update: createUpdateChart('level')
        },
        levelchange: {
          name: 'Level Change',
          init: function(graphContainer) {
            this.rooms = [];

            graphContainer.highcharts('StockChart', generateChartOptions(this));
          },
          update: createUpdateChart('levels_diff')
        },
        wormholes: {
          name: 'Wormholes',
          init: function(graphContainer) {
            this.rooms = [];

            graphContainer.highcharts('StockChart', generateChartOptions(this));
          },
          update: createUpdateChart('wormholes')
        }
      };

      $(document).ready(function() {
        Highcharts.setOptions({
          global: {
            useUTC: false
          }
        });

        for (var n in graphs) {
          var container = $('<div>').addClass('graph');
          $('#graphs').append(container);
          graphs[n].init(container);
        }

        function getData() {
          $.get('http://cors-anywhere.herokuapp.com/http://steamga.me/data/api/leaderboard.json').done(function(data) {
            for (var n in graphs) graphs[n].update(graphs[n], data);
          }).fail(function(a, b, c) {
            console.log(a, b, c);
          });
        }

        function getRoomNames() {
          $.get('https://cors-anywhere.herokuapp.com/https://raw.githubusercontent.com/opl-/towerattack-calc/master/names.json').done(function(data) {
            roomNames = data;

            for (var roomID in data) {
              for (var n in graphs) {
                if (graphs[n].rooms.indexOf(roomID) !== -1) {
                  graphs[n].graph.series[graphs[n].rooms.indexOf(roomID)].name = roomNames[roomID] ? roomID + ' (' + roomNames[roomID] + ')' : roomID;
                }
              }
            }
          }).fail(function(a, b, c) {
            console.log(a, b, c);
          });
        }

        getRoomNames();

        setInterval(getData, 5000);
        setInterval(getRoomNames, 30000);
      });
    </script>
  </head>
  <body>
    <h2>Room stats history</h2>
    <p>You can hide or show rooms by clicking on their labels on the bottom.<br/>Made by opl</p>
    <div id="graphs"></div>
  </body>
</html>